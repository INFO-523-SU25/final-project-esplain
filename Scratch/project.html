<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>project â€“ WNBA Referee Bias Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-991b1886d3c685c7aa2b62b80640c7af.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-08799928d293638fe9563d5c5a2794e5.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-991b1886d3c685c7aa2b62b80640c7af.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">WNBA Referee Bias Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Project</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../proposal.html"> 
<span class="menu-text">Proposal</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../presentation.html"> 
<span class="menu-text">Presentation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/INFO-523-SU25/final-project-esplain"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>





<div id="3c515d89" class="cell" data-execution_count="188">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For data handling</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># For clustering</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># For visualization</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="bd07d39f" class="cell" data-execution_count="189">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">"../data"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load individual season data</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>wnba_2022 <span class="op">=</span> pd.read_csv(os.path.join(data_folder, <span class="st">"wnba_2022.csv"</span>))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>wnba_2023 <span class="op">=</span> pd.read_csv(os.path.join(data_folder, <span class="st">"wnba_2023.csv"</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>wnba_2024 <span class="op">=</span> pd.read_csv(os.path.join(data_folder, <span class="st">"wnba_2024.csv"</span>))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all seasons into one dataset</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>wnba_data <span class="op">=</span> pd.concat([wnba_2022, wnba_2023, wnba_2024], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a year column for Time Actual that's in format ISO8601</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>wnba_data[<span class="st">'timeActual'</span>] <span class="op">=</span> pd.to_datetime(wnba_data[<span class="st">'timeActual'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'ISO8601'</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure 'timeActual' is in datetime format</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>wnba_data[<span class="st">'year'</span>] <span class="op">=</span> wnba_data[<span class="st">'timeActual'</span>].dt.year</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Display basic information about the dataset</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total records across all seasons: </span><span class="sc">{</span><span class="bu">len</span>(wnba_data)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Columns in dataset: </span><span class="sc">{</span>wnba_data<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Dataset shape: </span><span class="sc">{</span>wnba_data<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Dataset columns:"</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(wnba_data.columns.tolist())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total records across all seasons: 28,103
Columns in dataset: 58
Dataset shape: (28103, 58)

Dataset columns:
['actionNumber', 'clock', 'timeActual', 'period', 'periodType', 'actionType', 'subType', 'qualifiers', 'personId', 'x', 'y', 'possession', 'scoreHome', 'scoreAway', 'edited', 'orderNumber', 'xLegacy', 'yLegacy', 'isFieldGoal', 'side', 'description', 'personIdsFilter', 'teamId', 'teamTricode', 'descriptor', 'jumpBallRecoveredName', 'jumpBallRecoverdPersonId', 'playerName', 'playerNameI', 'jumpBallWonPlayerName', 'jumpBallWonPersonId', 'jumpBallLostPlayerName', 'jumpBallLostPersonId', 'shotDistance', 'shotResult', 'shotActionNumber', 'reboundTotal', 'reboundDefensiveTotal', 'reboundOffensiveTotal', 'pointsTotal', 'assistPlayerNameInitial', 'assistPersonId', 'assistTotal', 'turnoverTotal', 'stealPlayerName', 'stealPersonId', 'officialId', 'foulPersonalTotal', 'foulTechnicalTotal', 'foulDrawnPlayerName', 'foulDrawnPersonId', 'blockPlayerName', 'blockPersonId', 'gameId', 'isTargetScoreLastPeriod', 'area', 'areaDetail', 'year']</code></pre>
</div>
</div>
<div id="fdbc2357" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------  Game Metadata Analysis</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">1. Summary of the Game Data:"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of games: </span><span class="sc">{</span>wnba_data[<span class="st">'gameId'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert timeActual to datetime with proper format handling</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>wnba_data[<span class="st">'timeActual'</span>] <span class="op">=</span> pd.to_datetime(wnba_data[<span class="st">'timeActual'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'ISO8601'</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>min_date <span class="op">=</span> wnba_data[<span class="st">'timeActual'</span>].<span class="bu">min</span>().strftime(<span class="st">'%B %Y'</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>max_date <span class="op">=</span> wnba_data[<span class="st">'timeActual'</span>].<span class="bu">max</span>().strftime(<span class="st">'%B %Y'</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>min_date<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>max_date<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of teams: </span><span class="sc">{</span>wnba_data[<span class="st">'teamTricode'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Teams:"</span>, <span class="bu">sorted</span>(wnba_data[<span class="st">'teamTricode'</span>].dropna().unique()))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------- Referee Assignment Analysis  </span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">2. Summary of the Referee Assignments:"</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>referee_data <span class="op">=</span> wnba_data[wnba_data[<span class="st">'officialId'</span>].notnull()]</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the count of how many games have referee data</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>games_with_referee_data <span class="op">=</span> referee_data[<span class="st">'gameId'</span>].nunique()</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>total_games <span class="op">=</span> wnba_data[<span class="st">'gameId'</span>].nunique()</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Games with referee data: </span><span class="sc">{</span>games_with_referee_data<span class="sc">}</span><span class="ss"> out of </span><span class="sc">{</span>total_games<span class="sc">}</span><span class="ss"> total games (</span><span class="sc">{</span>games_with_referee_data<span class="op">/</span>total_games<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Records with referee data: </span><span class="sc">{</span><span class="bu">len</span>(referee_data)<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(referee_data)<span class="op">/</span><span class="bu">len</span>(wnba_data)<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique referees: </span><span class="sc">{</span>referee_data[<span class="st">'officialId'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Referee assignments per game</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>referee_assignments <span class="op">=</span> referee_data.groupby(<span class="st">'gameId'</span>)[<span class="st">'officialId'</span>].nunique().reset_index()</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>referee_assignments.columns <span class="op">=</span> [<span class="st">'gameId'</span>, <span class="st">'num_referees'</span>]</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average referees per game: </span><span class="sc">{</span>referee_assignments[<span class="st">'num_referees'</span>]<span class="sc">.</span>mean()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Most active referees based on unique gameids</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>top_referees <span class="op">=</span> referee_data.groupby(<span class="st">'officialId'</span>)[<span class="st">'gameId'</span>].nunique().sort_values(ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top 10 Most Active Referees (by unique games):"</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top_referees)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize of all referees by number of unique games</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>all_referees <span class="op">=</span> referee_data.groupby(<span class="st">'officialId'</span>)[<span class="st">'gameId'</span>].nunique().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>all_referees.index <span class="op">=</span> all_referees.index.astype(<span class="bu">str</span>)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>sns.barplot(</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>all_referees.index, </span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>all_referees.values</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Count of Unique Games per Referee'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Referee ID'</span>)</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Number of Unique Games'</span>)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------- Game Outcomes Analysis</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>games_summary <span class="op">=</span> wnba_data.groupby(<span class="st">'gameId'</span>).agg({</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">'scoreHome'</span>: <span class="st">'max'</span>,</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">'scoreAway'</span>: <span class="st">'max'</span>,</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">'teamTricode'</span>: <span class="st">'nunique'</span>,</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span>: <span class="st">'first'</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>}).reset_index()</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>games_summary[<span class="st">'point_differential'</span>] <span class="op">=</span> games_summary[<span class="st">'scoreHome'</span>] <span class="op">-</span> games_summary[<span class="st">'scoreAway'</span>]</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>games_summary[<span class="st">'home_win'</span>] <span class="op">=</span> games_summary[<span class="st">'point_differential'</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyzing by year the game outcomes</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>yearly_outcomes <span class="op">=</span> games_summary.groupby(<span class="st">'year'</span>).agg({</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">'gameId'</span>: <span class="st">'count'</span>,</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">'home_win'</span>: [<span class="st">'sum'</span>, <span class="st">'mean'</span>],</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">'point_differential'</span>: <span class="st">'mean'</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>}).<span class="bu">round</span>(<span class="dv">0</span>)</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Outcomes by Season:"</span>)</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> year <span class="kw">in</span> yearly_outcomes.index:</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    games_count <span class="op">=</span> yearly_outcomes.loc[year, (<span class="st">'gameId'</span>, <span class="st">'count'</span>)]</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    home_wins <span class="op">=</span> yearly_outcomes.loc[year, (<span class="st">'home_win'</span>, <span class="st">'sum'</span>)]</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    home_win_pct <span class="op">=</span> yearly_outcomes.loc[year, (<span class="st">'home_win'</span>, <span class="st">'mean'</span>)] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    avg_diff <span class="op">=</span> yearly_outcomes.loc[year, (<span class="st">'point_differential'</span>, <span class="st">'mean'</span>)]</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="bu">int</span>(year)<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">int</span>(games_count)<span class="sc">}</span><span class="ss"> games, </span><span class="sc">{</span><span class="bu">int</span>(home_wins)<span class="sc">}</span><span class="ss"> home wins , average point difference: </span><span class="sc">{</span><span class="bu">int</span>(avg_diff)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a><span class="co">#-------------------- Missing Values Analysis</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Missing Values Analysis:"</span>)</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the missing vaules for referee actions</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Key variables for referee analysis</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>key_variables <span class="op">=</span> [<span class="st">'gameId'</span>, <span class="st">'officialId'</span>, <span class="st">'teamTricode'</span>, <span class="st">'foulPersonalTotal'</span>, </span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>                <span class="st">'scoreHome'</span>, <span class="st">'scoreAway'</span>, <span class="st">'timeActual'</span>, <span class="st">'period'</span>]</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Missing values within actionType calls </span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>actiontype_total <span class="op">=</span> wnba_data.groupby(<span class="st">'actionType'</span>)[<span class="st">'officialId'</span>].size().reset_index(name<span class="op">=</span><span class="st">'total_count'</span>)</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>actiontype_with_ref <span class="op">=</span> wnba_data[wnba_data[<span class="st">'officialId'</span>].notnull()].groupby(<span class="st">'actionType'</span>)[<span class="st">'officialId'</span>].count().reset_index(name<span class="op">=</span><span class="st">'referee_count'</span>)</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>actiontype_counts <span class="op">=</span> pd.merge(actiontype_total, actiontype_with_ref, on<span class="op">=</span><span class="st">'actionType'</span>, how<span class="op">=</span><span class="st">'left'</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>actiontype_counts[<span class="st">'percent_missing'</span>] <span class="op">=</span> ((actiontype_counts[<span class="st">'total_count'</span>] <span class="op">-</span> actiontype_counts[<span class="st">'referee_count'</span>]) <span class="op">/</span> actiontype_counts[<span class="st">'total_count'</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">1</span>)</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>actiontype_counts <span class="op">=</span> actiontype_counts.sort_values(<span class="st">'percent_missing'</span>, ascending<span class="op">=</span><span class="va">False</span>).set_index(<span class="st">'actionType'</span>)</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(actiontype_counts[[<span class="st">'total_count'</span>, <span class="st">'referee_count'</span>, <span class="st">'percent_missing'</span>]])</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize missing values</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>))</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>sns.barplot(</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>actiontype_counts.index, </span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>actiontype_counts[<span class="st">'percent_missing'</span>])</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">75</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Referee ID Missingness by ActionType'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'ActionType'</span>)</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Percent Missing (%)'</span>)</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="dv">105</span>)</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize missing referee ID values for different subtypes within actionType = 'Turnover'</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>turnover_data <span class="op">=</span> wnba_data[wnba_data[<span class="st">'actionType'</span>] <span class="op">==</span> <span class="st">'turnover'</span>]</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>subtype_total <span class="op">=</span> turnover_data.groupby(<span class="st">'subType'</span>)[<span class="st">'officialId'</span>].size().reset_index(name<span class="op">=</span><span class="st">'total_count'</span>)</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>subtype_with_ref <span class="op">=</span> turnover_data[turnover_data[<span class="st">'officialId'</span>].notnull()].groupby(<span class="st">'subType'</span>)[<span class="st">'officialId'</span>].count().reset_index(name<span class="op">=</span><span class="st">'referee_count'</span>)</span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>subtype_counts <span class="op">=</span> pd.merge(subtype_total, subtype_with_ref, on<span class="op">=</span><span class="st">'subType'</span>, how<span class="op">=</span><span class="st">'left'</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>subtype_counts[<span class="st">'percent_missing'</span>] <span class="op">=</span> ((subtype_counts[<span class="st">'total_count'</span>] <span class="op">-</span> subtype_counts[<span class="st">'referee_count'</span>]) <span class="op">/</span> subtype_counts[<span class="st">'total_count'</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">1</span>)</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>subtype_counts <span class="op">=</span> subtype_counts.sort_values(<span class="st">'percent_missing'</span>, ascending<span class="op">=</span><span class="va">False</span>).set_index(<span class="st">'subType'</span>)</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Missing Referee ID Values for Turnover Subtypes:"</span>)</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(subtype_counts[[<span class="st">'total_count'</span>, <span class="st">'referee_count'</span>, <span class="st">'percent_missing'</span>]]) </span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize missing values</span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>))</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>sns.barplot(</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>subtype_counts.index, </span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>subtype_counts[<span class="st">'percent_missing'</span>])</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">75</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Referee ID Missingness by ActionType'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'ActionType'</span>)</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Percent Missing (%)'</span>)</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="dv">105</span>)</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
1. Summary of the Game Data:
Number of games: 65
Date range: August 2022 to October 2024
Number of teams: 11
Teams: ['ATL', 'CHI', 'CON', 'DAL', 'IND', 'LVA', 'MIN', 'NYL', 'PHO', 'SEA', 'WAS']

2. Summary of the Referee Assignments:
Games with referee data: 65 out of 65 total games (100.0%)
Records with referee data: 2,793 (9.9%)
Unique referees: 27
Average referees per game: 3.05

Top 10 Most Active Referees (by unique games):
officialId
100697.0     20
201538.0     20
100274.0     19
203440.0     18
202297.0     17
203800.0     16
1628702.0    14
203891.0      8
101044.0      8
1628167.0     8
Name: gameId, dtype: int64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-4-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Outcomes by Season:
2022: 23 games, 12 home wins , average point difference: 5
2023: 20 games, 13 home wins , average point difference: 9
2024: 22 games, 17 home wins , average point difference: 6

Missing Values Analysis:
              total_count  referee_count  percent_missing
actionType                                               
2pt                  6022            0.0            100.0
3pt                  2940            0.0            100.0
block                 566            0.0            100.0
freethrow            2044            0.0            100.0
game                   65            0.0            100.0
jumpball              191            0.0            100.0
substitution         5070            0.0            100.0
period                528            0.0            100.0
rebound              5416            0.0            100.0
steal                 876            0.0            100.0
timeout               664            0.0            100.0
turnover             1631          711.0             56.4
violation              87           80.0              8.0
foul                 2003         2002.0              0.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-4-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Missing Referee ID Values for Turnover Subtypes:
                       total_count  referee_count  percent_missing
subType                                                           
bad pass                       582            0.0            100.0
jumpball violation               2            0.0            100.0
offensive-kicked-ball            1            0.0            100.0
lost ball                      305            4.0             98.7
3-second-violation              17           14.0             17.6
backcourt                        9            8.0             11.1
shot clock                     129          115.0             10.9
out-of-bounds                  337          322.0              4.5
traveling                       96           95.0              1.0
5-second-violation               2            2.0              0.0
double dribble                   2            2.0              0.0
8-second-violation               2            2.0              0.0
offensive foul                 142          142.0              0.0
inbound                          1            1.0              0.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-4-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="53b79443" class="cell" data-execution_count="191">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">####  Data Cleaning and Preparation for Referee-level event counts from raw play-by-play</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Build home/away mapping</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>wnba_data <span class="op">=</span> wnba_data.copy()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>wnba_data[<span class="st">'scoreHome_num'</span>] <span class="op">=</span> pd.to_numeric(wnba_data.get(<span class="st">'scoreHome'</span>), errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>wnba_data[<span class="st">'scoreAway_num'</span>] <span class="op">=</span> pd.to_numeric(wnba_data.get(<span class="st">'scoreAway'</span>), errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>wnba_data <span class="op">=</span> wnba_data.sort_values([<span class="st">'gameId'</span>,<span class="st">'period'</span>,<span class="st">'timeActual'</span>], kind<span class="op">=</span><span class="st">'mergesort'</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>wnba_data[<span class="st">'home_diff'</span>] <span class="op">=</span> wnba_data.groupby(<span class="st">'gameId'</span>)[<span class="st">'scoreHome_num'</span>].diff()</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>wnba_data[<span class="st">'away_diff'</span>] <span class="op">=</span> wnba_data.groupby(<span class="st">'gameId'</span>)[<span class="st">'scoreAway_num'</span>].diff()</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>first_home <span class="op">=</span> (</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    wnba_data[wnba_data[<span class="st">'home_diff'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'gameId'</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    .agg(home_tricode<span class="op">=</span>(<span class="st">'teamTricode'</span>,<span class="st">'first'</span>))</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>first_away <span class="op">=</span> (</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    wnba_data[wnba_data[<span class="st">'away_diff'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'gameId'</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    .agg(away_tricode<span class="op">=</span>(<span class="st">'teamTricode'</span>,<span class="st">'first'</span>))</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>ha_map <span class="op">=</span> pd.merge(first_home, first_away, on<span class="op">=</span><span class="st">'gameId'</span>, how<span class="op">=</span><span class="st">'outer'</span>)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> wnba_data.merge(ha_map, on<span class="op">=</span><span class="st">'gameId'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'is_home'</span>] <span class="op">=</span> (df[<span class="st">'teamTricode'</span>] <span class="op">==</span> df[<span class="st">'home_tricode'</span>]).astype(<span class="bu">int</span>)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'is_away'</span>] <span class="op">=</span> (df[<span class="st">'teamTricode'</span>] <span class="op">==</span> df[<span class="st">'away_tricode'</span>]).astype(<span class="bu">int</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'away_game'</span>] <span class="op">=</span> (df[<span class="st">'is_away'</span>] <span class="op">==</span> <span class="dv">1</span>).astype(<span class="bu">int</span>)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Referee-level event table</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>ref_events <span class="op">=</span> wnba_data[wnba_data[<span class="st">'officialId'</span>].notna()].copy()</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="co">#-- assign each unique referee ID a unique alphabet label </span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ref_label(idx):</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"Ref </span><span class="sc">{</span><span class="bu">chr</span>(<span class="dv">65</span> <span class="op">+</span> idx)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Mapping from officialId based on sorted unique IDs</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>unique_ref_ids <span class="op">=</span> <span class="bu">sorted</span>(ref_events[<span class="st">'officialId'</span>].dropna().unique())</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>ref_id_to_label <span class="op">=</span> {ref_id: ref_label(i) <span class="cf">for</span> i, ref_id <span class="kw">in</span> <span class="bu">enumerate</span>(unique_ref_ids)}</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'actionType'</span>, <span class="st">'subType'</span>, <span class="st">'teamTricode'</span>]:</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> ref_events.columns:</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>        ref_events[col] <span class="op">=</span> ref_events[col].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip().<span class="bu">str</span>.lower().replace({<span class="st">'nan'</span>: np.nan})</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>ref_events[<span class="st">'teamTricode'</span>] <span class="op">=</span> ref_events[<span class="st">'teamTricode'</span>].fillna(<span class="st">'unknown'</span>)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>home_away_map <span class="op">=</span> df[[<span class="st">'gameId'</span>,<span class="st">'teamTricode'</span>,<span class="st">'is_home'</span>,<span class="st">'is_away'</span>,<span class="st">'away_game'</span>]].drop_duplicates()</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>ref_events <span class="op">=</span> ref_events.merge(home_away_map, on<span class="op">=</span>[<span class="st">'gameId'</span>,<span class="st">'teamTricode'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>ref_events[<span class="st">'team_status'</span>] <span class="op">=</span> np.where(ref_events[<span class="st">'is_home'</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">'home'</span>,</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>                            np.where(ref_events[<span class="st">'is_away'</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">'away'</span>, <span class="st">'unknown'</span>))</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Assign global ref_label ---</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>ref_events[<span class="st">'ref_label'</span>] <span class="op">=</span> ref_events[<span class="st">'officialId'</span>].<span class="bu">map</span>(ref_id_to_label)</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Base counts per (game, ref, teamTricode, team_status)</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>ref_event_counts <span class="op">=</span> (</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    ref_events.groupby([<span class="st">'gameId'</span>,<span class="st">'officialId'</span>,<span class="st">'ref_label'</span>,<span class="st">'teamTricode'</span>,<span class="st">'team_status'</span>])</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>        fouls_made<span class="op">=</span>(<span class="st">'actionType'</span>, <span class="kw">lambda</span> x: (x <span class="op">==</span> <span class="st">'foul'</span>).<span class="bu">sum</span>()),</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>        turnovers_made<span class="op">=</span>(<span class="st">'actionType'</span>, <span class="kw">lambda</span> x: (x <span class="op">==</span> <span class="st">'turnover'</span>).<span class="bu">sum</span>())</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Per-subtype counts (pivot wide by subtype) â€” include team_status in keys</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>subtype_counts <span class="op">=</span> (</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>    ref_events.groupby([<span class="st">'gameId'</span>,<span class="st">'officialId'</span>,<span class="st">'ref_label'</span>,<span class="st">'teamTricode'</span>,<span class="st">'team_status'</span>,<span class="st">'subType'</span>])</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>    .unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>key_cols <span class="op">=</span> [<span class="st">'gameId'</span>,<span class="st">'officialId'</span>,<span class="st">'ref_label'</span>,<span class="st">'teamTricode'</span>,<span class="st">'team_status'</span>]</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>sub_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> subtype_counts.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> key_cols]</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>subtype_counts <span class="op">=</span> subtype_counts.rename(columns<span class="op">=</span>{c: <span class="ss">f"st_</span><span class="sc">{</span><span class="bu">str</span>(c)<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c <span class="kw">in</span> sub_cols})</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>referee_game_data <span class="op">=</span> ref_event_counts.merge(</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>    subtype_counts,</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">'gameId'</span>,<span class="st">'officialId'</span>,<span class="st">'ref_label'</span>,<span class="st">'teamTricode'</span>,<span class="st">'team_status'</span>],</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>count_cols <span class="op">=</span> [<span class="st">'fouls_made'</span>,<span class="st">'turnovers_made'</span>] <span class="op">+</span> [c <span class="cf">for</span> c <span class="kw">in</span> referee_game_data.columns <span class="cf">if</span> c.startswith(<span class="st">'st_'</span>)]</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>referee_game_data[count_cols] <span class="op">=</span> referee_game_data[count_cols].fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Referee-game dataset shape: </span><span class="sc">{</span>referee_game_data<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique referees: </span><span class="sc">{</span>referee_game_data[<span class="st">'officialId'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Referee-game records: </span><span class="sc">{</span><span class="bu">len</span>(referee_game_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>sample_cols <span class="op">=</span> [<span class="st">'gameId'</span>,<span class="st">'officialId'</span>,<span class="st">'ref_label'</span>,<span class="st">'teamTricode'</span>,<span class="st">'team_status'</span>,<span class="st">'fouls_made'</span>,<span class="st">'turnovers_made'</span>]</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'st_traveling'</span> <span class="kw">in</span> referee_game_data.columns:</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>    sample_cols.append(<span class="st">'st_traveling'</span>)</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Sample of Referee-game dataset:"</span>)</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(referee_game_data[sample_cols].head(<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Referee-game dataset shape: (394, 24)
Unique referees: 27
Referee-game records: 394

Sample of Referee-game dataset:
       gameId  officialId ref_label teamTricode team_status  fouls_made  \
0  1042200101    100274.0     Ref A         lva     unknown           5   
1  1042200101    100274.0     Ref A         pho     unknown           3   
2  1042200101    101044.0     Ref E         lva     unknown           7   
3  1042200101    101044.0     Ref E         pho     unknown           7   
4  1042200101   1628167.0     Ref Q         lva     unknown           6   

   turnovers_made  st_traveling  
0               3             1  
1               1             0  
2               4             0  
3               2             0  
4               2             0  </code></pre>
</div>
</div>
<div id="f83359cc" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- normalize text fields</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">'actionType'</span>,<span class="st">'subType'</span>,<span class="st">'teamTricode'</span>]:</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="kw">in</span> wnba_data.columns:</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        wnba_data[c] <span class="op">=</span> wnba_data[c].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower().replace(<span class="st">'nan'</span>, np.nan)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># --- coerce scores to numeric</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>wnba_data[<span class="st">'scoreHome_num'</span>] <span class="op">=</span> pd.to_numeric(wnba_data[<span class="st">'scoreHome'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>wnba_data[<span class="st">'scoreAway_num'</span>] <span class="op">=</span> pd.to_numeric(wnba_data[<span class="st">'scoreAway'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># --- sort for correct order</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>wnba_data <span class="op">=</span> wnba_data.sort_values([<span class="st">'gameId'</span>,<span class="st">'period'</span>,<span class="st">'timeActual'</span>], kind<span class="op">=</span><span class="st">'mergesort'</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># --- detect scoreboard increments</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>wnba_data[<span class="st">'home_diff'</span>] <span class="op">=</span> wnba_data.groupby(<span class="st">'gameId'</span>)[<span class="st">'scoreHome_num'</span>].diff()</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>wnba_data[<span class="st">'away_diff'</span>] <span class="op">=</span> wnba_data.groupby(<span class="st">'gameId'</span>)[<span class="st">'scoreAway_num'</span>].diff()</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># --- first scoring teams = home/away</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>first_home <span class="op">=</span> (</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    wnba_data[wnba_data[<span class="st">'home_diff'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'gameId'</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    .agg(home_tricode<span class="op">=</span>(<span class="st">'teamTricode'</span>,<span class="st">'first'</span>))</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>first_away <span class="op">=</span> (</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    wnba_data[wnba_data[<span class="st">'away_diff'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'gameId'</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    .agg(away_tricode<span class="op">=</span>(<span class="st">'teamTricode'</span>,<span class="st">'first'</span>))</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>ha_map <span class="op">=</span> pd.merge(first_home, first_away, on<span class="op">=</span><span class="st">'gameId'</span>, how<span class="op">=</span><span class="st">'outer'</span>)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="co"># --- merge mapping back</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> wnba_data.merge(ha_map, on<span class="op">=</span><span class="st">'gameId'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'is_home'</span>] <span class="op">=</span> (df[<span class="st">'teamTricode'</span>] <span class="op">==</span> df[<span class="st">'home_tricode'</span>]).astype(<span class="bu">int</span>)</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'is_away'</span>] <span class="op">=</span> (df[<span class="st">'teamTricode'</span>] <span class="op">==</span> df[<span class="st">'away_tricode'</span>]).astype(<span class="bu">int</span>)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="co"># --- turnover types that involve whistles</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>turnover_keep <span class="op">=</span> {</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'3-second-violation'</span>,<span class="st">'backcourt'</span>,<span class="st">'shot clock'</span>,<span class="st">'out-of-bounds'</span>,</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'traveling'</span>,<span class="st">'5-second-violation'</span>,<span class="st">'double dribble'</span>,<span class="st">'8-second-violation'</span>,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">'offensive foul'</span>,<span class="st">'inbound'</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="co"># --- keep fouls + selected turnovers</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>mask_foul <span class="op">=</span> df[<span class="st">'actionType'</span>] <span class="op">==</span> <span class="st">'foul'</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>mask_to   <span class="op">=</span> (df[<span class="st">'actionType'</span>] <span class="op">==</span> <span class="st">'turnover'</span>) <span class="op">&amp;</span> df[<span class="st">'subType'</span>].isin(turnover_keep)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[mask_foul <span class="op">|</span> mask_to].copy()</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a><span class="co"># --- basic foul + turnover counts</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'foul_count'</span>] <span class="op">=</span> (df[<span class="st">'actionType'</span>] <span class="op">==</span> <span class="st">'foul'</span>).astype(<span class="bu">int</span>)</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'turnover_whistle'</span>] <span class="op">=</span> (df[<span class="st">'actionType'</span>] <span class="op">==</span> <span class="st">'turnover'</span>).astype(<span class="bu">int</span>)</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="co"># --- split by home/away</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'foul_count_home'</span>] <span class="op">=</span> df[<span class="st">'foul_count'</span>] <span class="op">*</span> df[<span class="st">'is_home'</span>]</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'foul_count_away'</span>] <span class="op">=</span> df[<span class="st">'foul_count'</span>] <span class="op">*</span> df[<span class="st">'is_away'</span>]</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'turnover_whistle_home'</span>] <span class="op">=</span> df[<span class="st">'turnover_whistle'</span>] <span class="op">*</span> df[<span class="st">'is_home'</span>]</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'turnover_whistle_away'</span>] <span class="op">=</span> df[<span class="st">'turnover_whistle'</span>] <span class="op">*</span> df[<span class="st">'is_away'</span>]</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a><span class="co"># GLOBAL REF LABEL MAPPING</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>unique_ref_ids <span class="op">=</span> <span class="bu">sorted</span>(df[<span class="st">'officialId'</span>].dropna().unique())</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>ref_id_to_label <span class="op">=</span> {ref_id: <span class="ss">f"Ref </span><span class="sc">{</span><span class="bu">chr</span>(<span class="dv">65</span><span class="op">+</span>i)<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i, ref_id <span class="kw">in</span> <span class="bu">enumerate</span>(unique_ref_ids)}</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Per-game crew label string using global mapping</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> crew_label_str(official_ids):</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    ids <span class="op">=</span> [oid <span class="cf">for</span> oid <span class="kw">in</span> <span class="bu">sorted</span>(<span class="bu">set</span>(official_ids)) <span class="cf">if</span> pd.notna(oid)]</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">', '</span>.join([ref_id_to_label[oid] <span class="cf">for</span> oid <span class="kw">in</span> ids])</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>crew_map <span class="op">=</span> (</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>    df.groupby(<span class="st">'gameId'</span>)[<span class="st">'officialId'</span>]</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>      .<span class="bu">apply</span>(<span class="kw">lambda</span> s: <span class="bu">sorted</span>(<span class="bu">set</span>(s.dropna())))</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>      .reset_index(name<span class="op">=</span><span class="st">'official_ids'</span>)</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>crew_map[<span class="st">'crew_combo'</span>] <span class="op">=</span> crew_map[<span class="st">'official_ids'</span>].<span class="bu">apply</span>(crew_label_str)</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>crew_map <span class="op">=</span> crew_map[[<span class="st">'gameId'</span>,<span class="st">'crew_combo'</span>]]</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Attach each eventâ€™s ref_label using the global mapping</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'ref_label'</span>] <span class="op">=</span> df[<span class="st">'officialId'</span>].<span class="bu">map</span>(ref_id_to_label)</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a><span class="co"># INDIVIDUAL (per ref per game) aggregates</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>referee_game_data <span class="op">=</span> (</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">'gameId'</span>,<span class="st">'officialId'</span>,<span class="st">'ref_label'</span>,<span class="st">'teamTricode'</span>])</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>      .agg(</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>          fouls_made<span class="op">=</span>(<span class="st">'foul_count'</span>,<span class="st">'sum'</span>),</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>          turnovers_made<span class="op">=</span>(<span class="st">'turnover_whistle'</span>,<span class="st">'sum'</span>),</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>          fouls_home<span class="op">=</span>(<span class="st">'foul_count_home'</span>,<span class="st">'sum'</span>),</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>          fouls_away<span class="op">=</span>(<span class="st">'foul_count_away'</span>,<span class="st">'sum'</span>),</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>          to_home<span class="op">=</span>(<span class="st">'turnover_whistle_home'</span>,<span class="st">'sum'</span>),</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>          to_away<span class="op">=</span>(<span class="st">'turnover_whistle_away'</span>,<span class="st">'sum'</span>)</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>      .reset_index()</span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a><span class="co"># CREW (per game) aggregates</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>games_with_refs <span class="op">=</span> (</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>    df.groupby(<span class="st">'gameId'</span>)</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>      .agg(</span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>          official_crew<span class="op">=</span>(<span class="st">'officialId'</span>, <span class="kw">lambda</span> x: <span class="bu">sorted</span>(<span class="bu">set</span>(x.dropna()))),</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>          foul_count<span class="op">=</span>(<span class="st">'foul_count'</span>,<span class="st">'sum'</span>),</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>          foul_count_home<span class="op">=</span>(<span class="st">'foul_count_home'</span>,<span class="st">'sum'</span>),</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>          foul_count_away<span class="op">=</span>(<span class="st">'foul_count_away'</span>,<span class="st">'sum'</span>),</span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>          turnover_whistle<span class="op">=</span>(<span class="st">'turnover_whistle'</span>,<span class="st">'sum'</span>),</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>          turnover_whistle_home<span class="op">=</span>(<span class="st">'turnover_whistle_home'</span>,<span class="st">'sum'</span>),</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>          turnover_whistle_away<span class="op">=</span>(<span class="st">'turnover_whistle_away'</span>,<span class="st">'sum'</span>),</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>          scoreHome<span class="op">=</span>(<span class="st">'scoreHome_num'</span>,<span class="st">'max'</span>),</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>          scoreAway<span class="op">=</span>(<span class="st">'scoreAway_num'</span>,<span class="st">'max'</span>)</span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>      .reset_index()</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the global crew label string</span></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>games_with_refs <span class="op">=</span> games_with_refs.merge(crew_map, on<span class="op">=</span><span class="st">'gameId'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>games_with_refs[<span class="st">'crew_size'</span>] <span class="op">=</span> games_with_refs[<span class="st">'official_crew'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> ids: <span class="bu">len</span>(<span class="bu">set</span>(ids)))</span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>games_with_refs[<span class="st">'point_diff_home'</span>] <span class="op">=</span> games_with_refs[<span class="st">'scoreHome'</span>] <span class="op">-</span> games_with_refs[<span class="st">'scoreAway'</span>]</span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>games_with_refs[<span class="st">'home_win'</span>] <span class="op">=</span> (games_with_refs[<span class="st">'point_diff_home'</span>] <span class="op">&gt;</span> <span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>games_with_refs[<span class="st">'away_game'</span>] <span class="op">=</span> (games_with_refs[<span class="st">'home_win'</span>] <span class="op">==</span> <span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>games_with_refs.to_csv(os.path.join(data_folder, <span class="st">'games_with_refs.csv'</span>), index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f5db853d" class="cell" data-execution_count="253">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) REFEREE-LEVEL DIFFERENCES (by ref_label)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure a label exists</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"ref_label"</span> <span class="kw">not</span> <span class="kw">in</span> referee_game_data.columns:</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    referee_game_data[<span class="st">"ref_label"</span>] <span class="op">=</span> referee_game_data[<span class="st">"officialId"</span>].astype(<span class="bu">str</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>have_split <span class="op">=</span> <span class="bu">all</span>(c <span class="kw">in</span> referee_game_data.columns <span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"fouls_home"</span>,<span class="st">"fouls_away"</span>,<span class="st">"to_home"</span>,<span class="st">"to_away"</span>])</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> have_split:</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Collapse to one row per (gameId, ref_label) if data are split by team</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    cols_to_sum <span class="op">=</span> [<span class="st">"fouls_home"</span>,<span class="st">"fouls_away"</span>,<span class="st">"to_home"</span>,<span class="st">"to_away"</span>]</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    ref_game <span class="op">=</span> (referee_game_data</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                .groupby([<span class="st">"gameId"</span>,<span class="st">"ref_label"</span>], as_index<span class="op">=</span><span class="va">False</span>)[cols_to_sum].<span class="bu">sum</span>())</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    ref_game[<span class="st">"foul_diff_game"</span>] <span class="op">=</span> ref_game[<span class="st">"fouls_away"</span>] <span class="op">-</span> ref_game[<span class="st">"fouls_home"</span>]</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    ref_game[<span class="st">"to_diff_game"</span>]   <span class="op">=</span> ref_game[<span class="st">"to_away"</span>]    <span class="op">-</span> ref_game[<span class="st">"to_home"</span>]</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Derive splits from team role column if needed</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    role_col <span class="op">=</span> <span class="st">"team_status"</span> <span class="cf">if</span> <span class="st">"team_status"</span> <span class="kw">in</span> referee_game_data.columns <span class="cf">else</span> (</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>               <span class="st">"team_role"</span>   <span class="cf">if</span> <span class="st">"team_role"</span>   <span class="kw">in</span> referee_game_data.columns <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> role_col <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Need split cols (fouls_home/away,to_home/away) OR a role column (team_status/team_role)."</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> referee_game_data[[<span class="st">"gameId"</span>,<span class="st">"ref_label"</span>,role_col,<span class="st">"fouls_made"</span>,<span class="st">"turnovers_made"</span>]].copy()</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    pvt <span class="op">=</span> tmp.pivot_table(index<span class="op">=</span>[<span class="st">"gameId"</span>,<span class="st">"ref_label"</span>],</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>                          columns<span class="op">=</span>role_col,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>                          values<span class="op">=</span>[<span class="st">"fouls_made"</span>,<span class="st">"turnovers_made"</span>],</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>                          aggfunc<span class="op">=</span><span class="st">"sum"</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>                          fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    home_fouls <span class="op">=</span> pvt[(<span class="st">"fouls_made"</span>,<span class="st">"home"</span>)] <span class="cf">if</span> (<span class="st">"fouls_made"</span>,<span class="st">"home"</span>) <span class="kw">in</span> pvt.columns <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    away_fouls <span class="op">=</span> pvt[(<span class="st">"fouls_made"</span>,<span class="st">"away"</span>)] <span class="cf">if</span> (<span class="st">"fouls_made"</span>,<span class="st">"away"</span>) <span class="kw">in</span> pvt.columns <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    home_to    <span class="op">=</span> pvt[(<span class="st">"turnovers_made"</span>,<span class="st">"home"</span>)] <span class="cf">if</span> (<span class="st">"turnovers_made"</span>,<span class="st">"home"</span>) <span class="kw">in</span> pvt.columns <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    away_to    <span class="op">=</span> pvt[(<span class="st">"turnovers_made"</span>,<span class="st">"away"</span>)] <span class="cf">if</span> (<span class="st">"turnovers_made"</span>,<span class="st">"away"</span>) <span class="kw">in</span> pvt.columns <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    ref_game <span class="op">=</span> pvt.reset_index()</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    ref_game[<span class="st">"foul_diff_game"</span>] <span class="op">=</span> np.array(away_fouls) <span class="op">-</span> np.array(home_fouls)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    ref_game[<span class="st">"to_diff_game"</span>]   <span class="op">=</span> np.array(away_to)    <span class="op">-</span> np.array(home_to)</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Average per ref_label</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>ref_summary <span class="op">=</span> (ref_game</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>               .groupby(<span class="st">"ref_label"</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>               .agg(</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>                   avg_foul_diff_away_home<span class="op">=</span>(<span class="st">"foul_diff_game"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>                   avg_turnover_diff_away_home<span class="op">=</span>(<span class="st">"to_diff_game"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>                   games_officiated<span class="op">=</span>(<span class="st">"gameId"</span>,<span class="st">"nunique"</span>)</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>               ))</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Orders for the two referee plots</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>ref_sorted_foul <span class="op">=</span> ref_summary.sort_values(<span class="st">"avg_foul_diff_away_home"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>order_refs_foul <span class="op">=</span> ref_sorted_foul[<span class="st">"ref_label"</span>].tolist()</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>ref_sorted_to   <span class="op">=</span> ref_summary.sort_values(<span class="st">"avg_turnover_diff_away_home"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>order_refs_to   <span class="op">=</span> ref_sorted_to[<span class="st">"ref_label"</span>].tolist()</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) CREW-LEVEL DIFFERENCES </span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>crew_name_col <span class="op">=</span> <span class="st">"crew_combo"</span> <span class="cf">if</span> <span class="st">"crew_combo"</span> <span class="kw">in</span> games_with_refs.columns <span class="cf">else</span> (</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>                <span class="st">"crew_str"</span>   <span class="cf">if</span> <span class="st">"crew_str"</span>   <span class="kw">in</span> games_with_refs.columns <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> crew_name_col <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    games_with_refs[<span class="st">"crew_str"</span>] <span class="op">=</span> games_with_refs[<span class="st">"official_crew"</span>].<span class="bu">apply</span>(</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> ids: <span class="st">", "</span>.join(<span class="bu">map</span>(<span class="bu">str</span>, <span class="bu">sorted</span>(ids))) <span class="cf">if</span> <span class="bu">isinstance</span>(ids, (<span class="bu">list</span>,<span class="bu">tuple</span>)) <span class="cf">else</span> <span class="bu">str</span>(ids)</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>    crew_name_col <span class="op">=</span> <span class="st">"crew_str"</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>crew_df <span class="op">=</span> games_with_refs.copy()</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>crew_df[<span class="st">"crew_foul_diff_game"</span>] <span class="op">=</span> crew_df[<span class="st">"foul_count_away"</span>] <span class="op">-</span> crew_df[<span class="st">"foul_count_home"</span>]</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>crew_df[<span class="st">"crew_to_diff_game"</span>]   <span class="op">=</span> crew_df[<span class="st">"turnover_whistle_away"</span>] <span class="op">-</span> crew_df[<span class="st">"turnover_whistle_home"</span>]</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>crew_summary <span class="op">=</span> (crew_df.groupby(crew_name_col, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>                .agg(</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>                    avg_foul_diff_per_game<span class="op">=</span>(<span class="st">"crew_foul_diff_game"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>                    avg_to_diff_per_game<span class="op">=</span>(<span class="st">"crew_to_diff_game"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>                    games_officiated<span class="op">=</span>(<span class="st">"gameId"</span>,<span class="st">"nunique"</span>)</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>                ))</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>crew_sorted_foul <span class="op">=</span> crew_summary.sort_values(<span class="st">"avg_foul_diff_per_game"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>order_crews_foul <span class="op">=</span> crew_sorted_foul[crew_name_col].tolist()</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>crew_sorted_to   <span class="op">=</span> crew_summary.sort_values(<span class="st">"avg_to_diff_per_game"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>order_crews_to   <span class="op">=</span> crew_sorted_to[crew_name_col].tolist()</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Add new calculations to the dataframes</span></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a><span class="co"># For referee-level: add total fouls and turnovers per game, plus home/away ratios</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>ref_game[<span class="st">"total_fouls"</span>] <span class="op">=</span> ref_game[<span class="st">"fouls_home"</span>] <span class="op">+</span> ref_game[<span class="st">"fouls_away"</span>]</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>ref_game[<span class="st">"total_turnovers"</span>] <span class="op">=</span> ref_game[<span class="st">"to_home"</span>] <span class="op">+</span> ref_game[<span class="st">"to_away"</span>]</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>ref_game[<span class="st">"foul_home_ratio"</span>] <span class="op">=</span> ref_game[<span class="st">"fouls_home"</span>] <span class="op">/</span> (ref_game[<span class="st">"total_fouls"</span>] <span class="op">+</span> <span class="fl">1e-6</span>)</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>ref_game[<span class="st">"foul_away_ratio"</span>] <span class="op">=</span> ref_game[<span class="st">"fouls_away"</span>] <span class="op">/</span> (ref_game[<span class="st">"total_fouls"</span>] <span class="op">+</span> <span class="fl">1e-6</span>)</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>ref_game[<span class="st">"to_home_ratio"</span>] <span class="op">=</span> ref_game[<span class="st">"to_home"</span>] <span class="op">/</span> (ref_game[<span class="st">"total_turnovers"</span>] <span class="op">+</span> <span class="fl">1e-6</span>)</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>ref_game[<span class="st">"to_away_ratio"</span>] <span class="op">=</span> ref_game[<span class="st">"to_away"</span>] <span class="op">/</span> (ref_game[<span class="st">"total_turnovers"</span>] <span class="op">+</span> <span class="fl">1e-6</span>)</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>ref_summary <span class="op">=</span> (ref_game</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"ref_label"</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>        avg_foul_diff_away_home<span class="op">=</span>(<span class="st">"foul_diff_game"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>        avg_turnover_diff_away_home<span class="op">=</span>(<span class="st">"to_diff_game"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>        games_officiated<span class="op">=</span>(<span class="st">"gameId"</span>,<span class="st">"nunique"</span>),</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>        avg_total_fouls<span class="op">=</span>(<span class="st">"total_fouls"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>        avg_total_turnovers<span class="op">=</span>(<span class="st">"total_turnovers"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>        avg_foul_home_ratio<span class="op">=</span>(<span class="st">"foul_home_ratio"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>        avg_foul_away_ratio<span class="op">=</span>(<span class="st">"foul_away_ratio"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>        avg_to_home_ratio<span class="op">=</span>(<span class="st">"to_home_ratio"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>        avg_to_away_ratio<span class="op">=</span>(<span class="st">"to_away_ratio"</span>,<span class="st">"mean"</span>)</span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a><span class="co"># For crew-level: add total fouls and turnovers per game, plus home/away ratios</span></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>crew_df[<span class="st">"crew_total_fouls"</span>] <span class="op">=</span> crew_df[<span class="st">"foul_count_home"</span>] <span class="op">+</span> crew_df[<span class="st">"foul_count_away"</span>]</span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>crew_df[<span class="st">"crew_total_turnovers"</span>] <span class="op">=</span> crew_df[<span class="st">"turnover_whistle_home"</span>] <span class="op">+</span> crew_df[<span class="st">"turnover_whistle_away"</span>]</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>crew_df[<span class="st">"crew_foul_home_ratio"</span>] <span class="op">=</span> crew_df[<span class="st">"foul_count_home"</span>] <span class="op">/</span> (crew_df[<span class="st">"crew_total_fouls"</span>] <span class="op">+</span> <span class="fl">1e-6</span>)</span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>crew_df[<span class="st">"crew_foul_away_ratio"</span>] <span class="op">=</span> crew_df[<span class="st">"foul_count_away"</span>] <span class="op">/</span> (crew_df[<span class="st">"crew_total_fouls"</span>] <span class="op">+</span> <span class="fl">1e-6</span>)</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>crew_df[<span class="st">"crew_to_home_ratio"</span>] <span class="op">=</span> crew_df[<span class="st">"turnover_whistle_home"</span>] <span class="op">/</span> (crew_df[<span class="st">"crew_total_turnovers"</span>] <span class="op">+</span> <span class="fl">1e-6</span>)</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>crew_df[<span class="st">"crew_to_away_ratio"</span>] <span class="op">=</span> crew_df[<span class="st">"turnover_whistle_away"</span>] <span class="op">/</span> (crew_df[<span class="st">"crew_total_turnovers"</span>] <span class="op">+</span> <span class="fl">1e-6</span>)</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>crew_summary <span class="op">=</span> (crew_df.groupby(crew_name_col, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>        avg_foul_diff_per_game<span class="op">=</span>(<span class="st">"crew_foul_diff_game"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>        avg_to_diff_per_game<span class="op">=</span>(<span class="st">"crew_to_diff_game"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>        games_officiated<span class="op">=</span>(<span class="st">"gameId"</span>,<span class="st">"nunique"</span>),</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>        avg_total_fouls<span class="op">=</span>(<span class="st">"crew_total_fouls"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>        avg_total_turnovers<span class="op">=</span>(<span class="st">"crew_total_turnovers"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>        avg_foul_home_ratio<span class="op">=</span>(<span class="st">"crew_foul_home_ratio"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>        avg_foul_away_ratio<span class="op">=</span>(<span class="st">"crew_foul_away_ratio"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>        avg_to_home_ratio<span class="op">=</span>(<span class="st">"crew_to_home_ratio"</span>,<span class="st">"mean"</span>),</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>        avg_to_away_ratio<span class="op">=</span>(<span class="st">"crew_to_away_ratio"</span>,<span class="st">"mean"</span>)</span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_bar_labels(ax, fmt<span class="op">=</span><span class="st">"</span><span class="sc">{:.1f}</span><span class="st">"</span>):</span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> ax.patches:</span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> p.get_height()</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> val <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>                ax.annotate(fmt.<span class="bu">format</span>(val),</span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>                            (p.get_x() <span class="op">+</span> p.get_width() <span class="op">/</span> <span class="dv">2</span>, val),</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>                            ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, xytext<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">3</span>),</span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>                            textcoords<span class="op">=</span><span class="st">'offset points'</span>)</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Referee plots ---</span></span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a><span class="co"># (A) Refs: Avg Foul Diff (Away âˆ’ Home) â€” sorted DESC (vertical)</span></span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">8</span>))</span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> sns.barplot(data<span class="op">=</span>ref_sorted_foul, x<span class="op">=</span><span class="st">"ref_label"</span>, y<span class="op">=</span><span class="st">"avg_foul_diff_away_home"</span>, order<span class="op">=</span>order_refs_foul)</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>ax1.axhline(<span class="dv">0</span>, lw<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">"Referees â€” Avg Foul Difference (Away âˆ’ Home) per Game"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, pad<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">"Referee"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">"Avg Foul Diff (Away âˆ’ Home)"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>ax1.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, rotation<span class="op">=</span><span class="dv">90</span>, labelsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>add_bar_labels(ax1)</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a><span class="co"># (B) Refs: Avg Whistle TO Diff (Away âˆ’ Home) â€” sorted DESC (vertical)</span></span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">8</span>))</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> sns.barplot(data<span class="op">=</span>ref_sorted_to, x<span class="op">=</span><span class="st">"ref_label"</span>, y<span class="op">=</span><span class="st">"avg_turnover_diff_away_home"</span>, order<span class="op">=</span>order_refs_to)</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>ax2.axhline(<span class="dv">0</span>, lw<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">"Referees â€” Avg Whistle Turnover Difference (Away âˆ’ Home) per Game"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, pad<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">"Referee"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">"Avg TO Diff (Away âˆ’ Home)"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>ax2.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, rotation<span class="op">=</span><span class="dv">90</span>, labelsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>add_bar_labels(ax2)</span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Crew plots ---</span></span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a><span class="co"># Crews: Avg Foul Diff â€” ALL crews</span></span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">8</span>))</span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>ax3 <span class="op">=</span> sns.barplot(data<span class="op">=</span>crew_sorted_foul, x<span class="op">=</span>crew_name_col, y<span class="op">=</span><span class="st">"avg_foul_diff_per_game"</span>, order<span class="op">=</span>order_crews_foul)</span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>ax3.axhline(<span class="dv">0</span>, lw<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">"Crews â€” Avg Foul Difference (Away âˆ’ Home) per Game"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, pad<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>ax3.set_xlabel(<span class="st">"Crew"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">"Avg Foul Diff (Away âˆ’ Home)"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>ax3.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, rotation<span class="op">=</span><span class="dv">90</span>, labelsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a>ax3.margins(x<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>add_bar_labels(ax3)</span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a><span class="co"># Crews: Avg Whistle TO Diff â€” ALL crews</span></span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">8</span>))</span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>ax4 <span class="op">=</span> sns.barplot(data<span class="op">=</span>crew_sorted_to, x<span class="op">=</span>crew_name_col, y<span class="op">=</span><span class="st">"avg_to_diff_per_game"</span>, order<span class="op">=</span>order_crews_to)</span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>ax4.axhline(<span class="dv">0</span>, lw<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a>ax4.set_title(<span class="st">"Crews â€” Avg Whistle Turnover Difference (Away âˆ’ Home) per Game"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, pad<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a>ax4.set_xlabel(<span class="st">"Crew"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>ax4.set_ylabel(<span class="st">"Avg TO Diff (Away âˆ’ Home)"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>ax4.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, rotation<span class="op">=</span><span class="dv">90</span>, labelsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>ax4.margins(x<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>add_bar_labels(ax4)</span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-7-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-7-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-7-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b89b1c9e" class="cell" data-execution_count="254">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>palette <span class="op">=</span> sns.color_palette(<span class="st">"crest"</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>COLOR_OUTLIER <span class="op">=</span> <span class="st">"red"</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- helpers ----------</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_outliers(df, x_col, y_col, n<span class="op">=</span><span class="dv">10</span>, center<span class="op">=</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>)):</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Return top-n farthest points from `center` (default neutral 0,0)."""</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> np.array(center, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    pts <span class="op">=</span> df[[x_col, y_col]].to_numpy(dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    dist <span class="op">=</span> np.linalg.norm(pts <span class="op">-</span> c, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.iloc[dist.argsort()[<span class="op">-</span>n:]]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annotate_quadrants(ax, x0<span class="op">=</span><span class="fl">0.0</span>, y0<span class="op">=</span><span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"blue"</span>, fx<span class="op">=</span><span class="fl">0.45</span>, fy<span class="op">=</span><span class="fl">0.45</span>, fs<span class="op">=</span><span class="dv">9</span>):</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Place quadrant labels inside each quadrant, relative to (x0,y0)."""</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    ax.axvline(x0, ls<span class="op">=</span><span class="st">"--"</span>, lw<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">"gray"</span>, zorder<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    ax.axhline(y0, ls<span class="op">=</span><span class="st">"--"</span>, lw<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">"gray"</span>, zorder<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    xlo, xhi <span class="op">=</span> ax.get_xlim()<span class="op">;</span> ylo, yhi <span class="op">=</span> ax.get_ylim()</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    xR <span class="op">=</span> x0 <span class="op">+</span> fx<span class="op">*</span>(xhi <span class="op">-</span> x0)<span class="op">;</span> xL <span class="op">=</span> x0 <span class="op">-</span> fx<span class="op">*</span>(x0 <span class="op">-</span> xlo)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    yT <span class="op">=</span> y0 <span class="op">+</span> fy<span class="op">*</span>(yhi <span class="op">-</span> y0)<span class="op">;</span> yB <span class="op">=</span> y0 <span class="op">-</span> fy<span class="op">*</span>(y0 <span class="op">-</span> ylo)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    box <span class="op">=</span> <span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.3"</span>, fc<span class="op">=</span><span class="st">"white"</span>, ec<span class="op">=</span><span class="st">"none"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    ax.text(xR, yT, <span class="st">"More fouls &amp; more TOs on AWAY</span><span class="ch">\n</span><span class="st">(strict on away)"</span>,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span>fs, color<span class="op">=</span>color, bbox<span class="op">=</span>box, clip_on<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    ax.text(xL, yT, <span class="st">"Fewer fouls on AWAY, more TOs on AWAY</span><span class="ch">\n</span><span class="st">(turnover-heavy on away)"</span>,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span>fs, color<span class="op">=</span>color, bbox<span class="op">=</span>box, clip_on<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    ax.text(xR, yB, <span class="st">"More fouls on AWAY, fewer TOs on AWAY</span><span class="ch">\n</span><span class="st">(foul-heavy on away)"</span>,</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span>fs, color<span class="op">=</span>color, bbox<span class="op">=</span>box, clip_on<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    ax.text(xL, yB, <span class="st">"Fewer fouls &amp; fewer TOs on AWAY</span><span class="ch">\n</span><span class="st">(lenient on away)"</span>,</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span>fs, color<span class="op">=</span>color, bbox<span class="op">=</span>box, clip_on<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> label_outliers(ax, df, x_col, y_col, id_col, dx_frac<span class="op">=</span><span class="fl">0.00</span>, dy_frac<span class="op">=</span><span class="fl">0.02</span>, color<span class="op">=</span><span class="st">"black"</span>, fs<span class="op">=</span><span class="dv">9</span>):</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Label points just BELOW each outlier dot (axis-relative offset)."""</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    xlo, xhi <span class="op">=</span> ax.get_xlim()<span class="op">;</span> ylo, yhi <span class="op">=</span> ax.get_ylim()</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    dx <span class="op">=</span> dx_frac <span class="op">*</span> (xhi <span class="op">-</span> xlo)<span class="op">;</span> dy <span class="op">=</span> dy_frac <span class="op">*</span> (yhi <span class="op">-</span> ylo)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, r <span class="kw">in</span> df.iterrows():</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>        ax.text(r[x_col] <span class="op">+</span> dx, r[y_col] <span class="op">-</span> dy, <span class="bu">str</span>(r[id_col]),</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>                ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"top"</span>, fontsize<span class="op">=</span>fs, color<span class="op">=</span>color, clip_on<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------- INDIVIDUAL REFEREES ---------------</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>out_refs <span class="op">=</span> get_outliers(ref_summary,</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'avg_foul_diff_away_home'</span>,</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'avg_turnover_diff_away_home'</span>,</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>                        n<span class="op">=</span><span class="dv">5</span>, center<span class="op">=</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>))</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">6</span>))</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(data<span class="op">=</span>ref_summary,</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>                x<span class="op">=</span><span class="st">'avg_foul_diff_away_home'</span>, y<span class="op">=</span><span class="st">'avg_turnover_diff_away_home'</span>,</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>                size<span class="op">=</span><span class="st">'games_officiated'</span>, sizes<span class="op">=</span>(<span class="dv">30</span>, <span class="dv">300</span>),</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.8</span>, color<span class="op">=</span>palette[<span class="dv">2</span>], legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(data<span class="op">=</span>out_refs,</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>                x<span class="op">=</span><span class="st">'avg_foul_diff_away_home'</span>, y<span class="op">=</span><span class="st">'avg_turnover_diff_away_home'</span>,</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>                size<span class="op">=</span><span class="st">'games_officiated'</span>, sizes<span class="op">=</span>(<span class="dv">30</span>, <span class="dv">300</span>),</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.95</span>, color<span class="op">=</span>COLOR_OUTLIER, legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>annotate_quadrants(plt.gca(), x0<span class="op">=</span><span class="fl">0.0</span>, y0<span class="op">=</span><span class="fl">0.0</span>, fx<span class="op">=</span><span class="fl">0.45</span>, fy<span class="op">=</span><span class="fl">0.45</span>, fs<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>label_outliers(plt.gca(), out_refs,</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>               <span class="st">'avg_foul_diff_away_home'</span>, <span class="st">'avg_turnover_diff_away_home'</span>,</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>               <span class="st">'ref_label'</span>, dy_frac<span class="op">=</span><span class="fl">0.025</span>, fs<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Individual Referees:</span><span class="ch">\n</span><span class="st">Avg Foul vs. Turnover Whistle Difference (Away - Home) per Game'</span>,</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>          fontsize<span class="op">=</span><span class="dv">14</span>, pad<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Avg Foul Difference (Away - Home) per Game'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Avg Turnover Whistle Difference (Away - Home) per Game'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">False</span>)</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------- REFEREE CREWS ----------------</span></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>out_crews <span class="op">=</span> get_outliers(crew_summary,</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'avg_foul_diff_per_game'</span>, <span class="st">'avg_to_diff_per_game'</span>,</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>                         n<span class="op">=</span><span class="dv">5</span>, center<span class="op">=</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>))</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>))</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(data<span class="op">=</span>crew_summary,</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>                x<span class="op">=</span><span class="st">'avg_foul_diff_per_game'</span>, y<span class="op">=</span><span class="st">'avg_to_diff_per_game'</span>,</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>                size<span class="op">=</span><span class="st">'games_officiated'</span>, sizes<span class="op">=</span>(<span class="dv">30</span>, <span class="dv">300</span>),</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.8</span>, color<span class="op">=</span>palette[<span class="dv">3</span>], legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(data<span class="op">=</span>out_crews,</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>                x<span class="op">=</span><span class="st">'avg_foul_diff_per_game'</span>, y<span class="op">=</span><span class="st">'avg_to_diff_per_game'</span>,</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>                size<span class="op">=</span><span class="st">'games_officiated'</span>, sizes<span class="op">=</span>(<span class="dv">30</span>, <span class="dv">300</span>),</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.95</span>, color<span class="op">=</span>COLOR_OUTLIER, legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>annotate_quadrants(plt.gca(), x0<span class="op">=</span><span class="fl">0.0</span>, y0<span class="op">=</span><span class="fl">0.0</span>, fx<span class="op">=</span><span class="fl">0.45</span>, fy<span class="op">=</span><span class="fl">0.45</span>, fs<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>label_outliers(plt.gca(), out_crews,</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>               <span class="st">'avg_foul_diff_per_game'</span>, <span class="st">'avg_to_diff_per_game'</span>,</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>               crew_name_col, dy_frac<span class="op">=</span><span class="fl">0.025</span>, fs<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Referee Crews:</span><span class="ch">\n</span><span class="st">Avg Foul vs. Turnover Whistle Difference (Away - Home) per Game'</span>,</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>          fontsize<span class="op">=</span><span class="dv">14</span>, pad<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Avg Foul Difference (Away - Home) per Game'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Avg Turnover Whistle Difference (Away - Home) per Game'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">False</span>)</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-8-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="82453725" class="cell" data-execution_count="260">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> silhouette_score, calinski_harabasz_score</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Refs  ----- features and clustering</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>ref_features <span class="op">=</span> ref_summary[[<span class="st">'ref_label'</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'avg_foul_diff_away_home'</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'avg_turnover_diff_away_home'</span>,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'games_officiated'</span>]].copy()</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>ref_X <span class="op">=</span> ref_features[[<span class="st">'avg_foul_diff_away_home'</span>,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'avg_turnover_diff_away_home'</span>,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'games_officiated'</span>]].fillna(<span class="fl">0.0</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>ref_X_scaled <span class="op">=</span> StandardScaler().fit_transform(ref_X)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Crews ----- features and clustering</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>crew_label_col <span class="op">=</span> <span class="st">'crew_combo'</span> <span class="cf">if</span> <span class="st">'crew_combo'</span> <span class="kw">in</span> crew_summary.columns <span class="cf">else</span> <span class="st">'crew_str'</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>crew_features <span class="op">=</span> crew_summary[[crew_label_col,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'avg_foul_diff_per_game'</span>,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'avg_to_diff_per_game'</span>,</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'games_officiated'</span>]].copy()</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>crew_X <span class="op">=</span> crew_features[[<span class="st">'avg_foul_diff_per_game'</span>,</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'avg_to_diff_per_game'</span>,</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'games_officiated'</span>]].fillna(<span class="fl">0.0</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>crew_X_scaled <span class="op">=</span> StandardScaler().fit_transform(crew_X)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>k_grid <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">10</span>))</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Refs ---- - Calinski-Harabasz scores</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>ref_scores <span class="op">=</span> []</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> k_grid:</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    km <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>k, random_state<span class="op">=</span><span class="dv">42</span>, n_init<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    lbl <span class="op">=</span> km.fit_predict(ref_X_scaled)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    ref_scores.append(calinski_harabasz_score(ref_X_scaled, lbl))</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Crews ---- - Calinski-Harabasz scores</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>crew_scores <span class="op">=</span> []</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> k_grid:</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    km <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>k, random_state<span class="op">=</span><span class="dv">42</span>, n_init<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    lbl <span class="op">=</span> km.fit_predict(crew_X_scaled)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    crew_scores.append(calinski_harabasz_score(crew_X_scaled, lbl))</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot CH curves as individual plots</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>chosen_k_ref  <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>chosen_k_crew <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Calinskiâ€“Harabasz (Refs)</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">5</span>))</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>plt.plot(k_grid, ref_scores, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>ref_ch_at_choice <span class="op">=</span> ref_scores[k_grid.index(chosen_k_ref)]</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>plt.axvline(chosen_k_ref, ls<span class="op">=</span><span class="st">'--'</span>, lw<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>plt.scatter([chosen_k_ref], [ref_ch_at_choice], zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>plt.text(chosen_k_ref, ref_ch_at_choice,</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'  chosen k=</span><span class="sc">{</span>chosen_k_ref<span class="sc">}</span><span class="ch">\n</span><span class="ss">  CH=</span><span class="sc">{</span>ref_ch_at_choice<span class="sc">:.1f}</span><span class="ss">'</span>,</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>         va<span class="op">=</span><span class="st">'bottom'</span>, ha<span class="op">=</span><span class="st">'left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Calinskiâ€“Harabasz (Refs)'</span>)</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'k'</span>)<span class="op">;</span> plt.ylabel(<span class="st">'CH score'</span>)<span class="op">;</span> plt.grid(<span class="va">False</span>)</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Calinskiâ€“Harabasz (Crews)</span></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">5</span>))</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>plt.plot(k_grid, crew_scores, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>crew_ch_at_choice <span class="op">=</span> crew_scores[k_grid.index(chosen_k_crew)]</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>plt.axvline(chosen_k_crew, ls<span class="op">=</span><span class="st">'--'</span>, lw<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>plt.scatter([chosen_k_crew], [crew_ch_at_choice], zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>plt.text(chosen_k_crew, crew_ch_at_choice,</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'  chosen k=</span><span class="sc">{</span>chosen_k_crew<span class="sc">}</span><span class="ch">\n</span><span class="ss">  CH=</span><span class="sc">{</span>crew_ch_at_choice<span class="sc">:.1f}</span><span class="ss">'</span>,</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>         va<span class="op">=</span><span class="st">'bottom'</span>, ha<span class="op">=</span><span class="st">'left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Calinskiâ€“Harabasz (Crews)'</span>)</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'k'</span>)<span class="op">;</span> plt.ylabel(<span class="st">'CH score'</span>)<span class="op">;</span> plt.grid(<span class="va">False</span>)</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Individual Referees --- KMeans clustering</span></span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>km_ref <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>chosen_k_ref, random_state<span class="op">=</span><span class="dv">42</span>, n_init<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>ref_features[<span class="st">'cluster'</span>] <span class="op">=</span> km_ref.fit_predict(ref_X_scaled)</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>pca_ref <span class="op">=</span> PCA(n_components<span class="op">=</span><span class="dv">2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>ref_pca <span class="op">=</span> pca_ref.fit_transform(ref_X_scaled)</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>v1, v2 <span class="op">=</span> pca_ref.explained_variance_ratio_ <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="fl">7.2</span>, <span class="dv">6</span>))</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.scatterplot(x<span class="op">=</span>ref_pca[:,<span class="dv">0</span>], y<span class="op">=</span>ref_pca[:,<span class="dv">1</span>],</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>                     hue<span class="op">=</span>ref_features[<span class="st">'cluster'</span>], palette<span class="op">=</span><span class="st">"tab10"</span>,</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>                     alpha<span class="op">=</span><span class="fl">0.9</span>, s<span class="op">=</span><span class="dv">70</span>, edgecolor<span class="op">=</span><span class="st">"k"</span>, linewidth<span class="op">=</span><span class="fl">0.4</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Referee Clusters (PCA of diff features)"</span>)</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="ss">f"PCA 1 (</span><span class="sc">{</span>v1<span class="sc">:.1f}</span><span class="ss">% var)"</span>)</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="ss">f"PCA 2 (</span><span class="sc">{</span>v2<span class="sc">:.1f}</span><span class="ss">% var)"</span>)</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">False</span>)<span class="op">;</span> ax.set_aspect(<span class="st">"equal"</span>, adjustable<span class="op">=</span><span class="st">"datalim"</span>)</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>ax.legend(title<span class="op">=</span><span class="st">"Cluster"</span>, loc<span class="op">=</span><span class="st">"best"</span>, frameon<span class="op">=</span><span class="va">True</span>, framealpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>sil_ref <span class="op">=</span> silhouette_score(ref_X_scaled, ref_features[<span class="st">'cluster'</span>])</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[REF] chosen k: </span><span class="sc">{</span>chosen_k_ref<span class="sc">}</span><span class="ss"> | silhouette: </span><span class="sc">{</span>sil_ref<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Crews --- KMeans clustering</span></span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>km_crew <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>chosen_k_crew, random_state<span class="op">=</span><span class="dv">42</span>, n_init<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>crew_features[<span class="st">'cluster'</span>] <span class="op">=</span> km_crew.fit_predict(crew_X_scaled)</span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>pca_crew <span class="op">=</span> PCA(n_components<span class="op">=</span><span class="dv">2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>crew_pca <span class="op">=</span> pca_crew.fit_transform(crew_X_scaled)</span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>cv1, cv2 <span class="op">=</span> pca_crew.explained_variance_ratio_ <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="fl">7.2</span>, <span class="dv">6</span>))</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.scatterplot(x<span class="op">=</span>crew_pca[:,<span class="dv">0</span>], y<span class="op">=</span>crew_pca[:,<span class="dv">1</span>],</span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a>                     hue<span class="op">=</span>crew_features[<span class="st">'cluster'</span>], palette<span class="op">=</span><span class="st">"tab10"</span>,</span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a>                     alpha<span class="op">=</span><span class="fl">0.9</span>, s<span class="op">=</span><span class="dv">70</span>, edgecolor<span class="op">=</span><span class="st">"k"</span>, linewidth<span class="op">=</span><span class="fl">0.4</span>, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Referee Crew Clusters (PCA of diff features)"</span>)</span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="ss">f"PCA 1 (</span><span class="sc">{</span>cv1<span class="sc">:.1f}</span><span class="ss">% var)"</span>)</span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="ss">f"PCA 2 (</span><span class="sc">{</span>cv2<span class="sc">:.1f}</span><span class="ss">% var)"</span>)</span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">False</span>)<span class="op">;</span> ax.set_aspect(<span class="st">"equal"</span>, adjustable<span class="op">=</span><span class="st">"datalim"</span>)</span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>ax.legend(title<span class="op">=</span><span class="st">"Cluster"</span>, loc<span class="op">=</span><span class="st">"best"</span>, frameon<span class="op">=</span><span class="va">True</span>, framealpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()<span class="op">;</span> plt.show()</span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>sil_crew <span class="op">=</span> silhouette_score(crew_X_scaled, crew_features[<span class="st">'cluster'</span>])</span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[CREW] chosen k: </span><span class="sc">{</span>chosen_k_crew<span class="sc">}</span><span class="ss"> | silhouette: </span><span class="sc">{</span>sil_crew<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(
c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-9-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-9-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-9-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[REF] chosen k: 6 | silhouette: 0.376</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>c:\Users\amyes\anaconda3\Lib\site-packages\sklearn\cluster\_kmeans.py:1419: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="project_files/figure-html/cell-9-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[CREW] chosen k: 8 | silhouette: 0.442</code></pre>
</div>
</div>
<div id="c137ede6" class="cell" data-execution_count="261">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- PCA loadings (how each original feature contributes to PC axes)</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_loadings(pca, feature_names, title):</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> pd.DataFrame(pca.components_, columns<span class="op">=</span>feature_names, index<span class="op">=</span>[<span class="ss">f'PC</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(pca.n_components_)])</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    exp <span class="op">=</span> (pca.explained_variance_ratio_ <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">1</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>title<span class="sc">}</span><span class="ss"> loadings (% var: </span><span class="sc">{</span><span class="bu">list</span>(exp)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(L.<span class="bu">round</span>(<span class="dv">3</span>))</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>print_loadings(pca_ref, [<span class="st">'avg_foul_diff_away_home'</span>,<span class="st">'avg_turnover_diff_away_home'</span>,<span class="st">'games_officiated'</span>],</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>               <span class="st">"REF PCA"</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>print_loadings(pca_crew, [<span class="st">'avg_foul_diff_per_game'</span>,<span class="st">'avg_to_diff_per_game'</span>,<span class="st">'games_officiated'</span>],</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>               <span class="st">"CREW PCA"</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Per-cluster means and sizes (REFS)</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>ref_cluster_summary <span class="op">=</span> (</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    ref_features</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'cluster'</span>, as_index<span class="op">=</span><span class="va">False</span>)[[<span class="st">'avg_foul_diff_away_home'</span>,<span class="st">'avg_turnover_diff_away_home'</span>,<span class="st">'games_officiated'</span>]]</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    .assign(n<span class="op">=</span><span class="kw">lambda</span> d: ref_features.groupby(<span class="st">'cluster'</span>).size().values)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">'cluster'</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Referee clusters â€” feature means and sizes"</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ref_cluster_summary.<span class="bu">round</span>(<span class="dv">3</span>))</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Per-cluster means and sizes (CREWS)</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>crew_cluster_summary <span class="op">=</span> (</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    crew_features</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'cluster'</span>, as_index<span class="op">=</span><span class="va">False</span>)[[<span class="st">'avg_foul_diff_per_game'</span>,<span class="st">'avg_to_diff_per_game'</span>,<span class="st">'games_officiated'</span>]]</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    .assign(n<span class="op">=</span><span class="kw">lambda</span> d: crew_features.groupby(<span class="st">'cluster'</span>).size().values)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">'cluster'</span>)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Crew clusters â€” feature means and sizes"</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(crew_cluster_summary.<span class="bu">round</span>(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
REF PCA loadings (% var: [np.float64(50.8), np.float64(31.3)])
     avg_foul_diff_away_home  avg_turnover_diff_away_home  games_officiated
PC1                    0.653                        0.677             0.339
PC2                   -0.320                       -0.158             0.934

CREW PCA loadings (% var: [np.float64(46.1), np.float64(29.5)])
     avg_foul_diff_per_game  avg_to_diff_per_game  games_officiated
PC1                   0.633                 0.599            -0.489
PC2                   0.213                 0.473             0.855

Referee clusters â€” feature means and sizes
   cluster  avg_foul_diff_away_home  avg_turnover_diff_away_home  \
0        0                    0.083                        0.750   
1        1                   -1.060                        0.040   
2        2                    0.417                        0.373   
3        3                    4.083                        0.833   
4        4                   -0.035                       -0.667   
5        5                   -5.000                       -1.000   

   games_officiated  n  
0             4.000  4  
1             2.200  5  
2            17.714  7  
3             3.667  3  
4             5.000  7  
5             1.000  1  

Crew clusters â€” feature means and sizes
   cluster  avg_foul_diff_per_game  avg_to_diff_per_game  games_officiated   n
0        0                   2.556                 2.556               1.0   9
1        1                   0.429                -2.286               1.0   7
2        2                  -0.714                -0.214               2.0   7
3        3                  -3.583                 0.167               1.0  12
4        4                   4.867                 0.533               1.0  15
5        5                  -4.000                 5.333               1.0   3
6        6                  -1.000               -10.000               1.0   1
7        7                   9.000                 4.750               1.0   4</code></pre>
</div>
</div>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/INFO-523-SU25\.github\.io\/final-project-esplain\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>