{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "fe2272bb",
   "metadata": {},
   "source": [
    "---\n",
    "title: \"Whistle Bias?\"\n",
    "subtitle: \"Investigating Referee Influence on WNBA Home Game Outcomes Using Data Mining\"\n",
    "author: \n",
    "  - name: \"Amy Esplain\"\n",
    "    affiliations:\n",
    "      - name: \"College of Information Science, University of Arizona\"\n",
    "description: \"This project aims to investigate potential officiating bias in WNBA games by analyzing referee crew assignments, foul distributions, and game outcomes. The primary objective is to determine whether certain referee combinations disproportionately favor home teams or exhibit consistent patterns of foul disparities.\"\n",
    "format:\n",
    "  html:\n",
    "    code-tools: true\n",
    "    code-overflow: wrap\n",
    "    code-line-numbers: true\n",
    "    embed-resources: true\n",
    "editor: visual\n",
    "code-annotations: hover\n",
    "execute:\n",
    "  warning: false\n",
    "jupyter: python3\n",
    "---"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "load-pkgs",
   "metadata": {
    "message": false
   },
   "outputs": [],
   "source": [
    "#| label: load-pkgs\n",
    "\n",
    "\n",
    "# For data handling\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "\n",
    "# For clustering\n",
    "from sklearn.cluster import KMeans\n",
    "from sklearn.preprocessing import StandardScaler\n",
    "\n",
    "# For visualization\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn as sns\n",
    "from sklearn.decomposition import PCA"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "79b8195a",
   "metadata": {},
   "source": [
    "## Dataset\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "load-dataset",
   "metadata": {
    "message": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Total records across all seasons: 28,103\n",
      "Columns in dataset: 57\n",
      "Dataset shape: (28103, 57)\n",
      "\n",
      "Dataset columns:\n",
      "['actionNumber', 'clock', 'timeActual', 'period', 'periodType', 'actionType', 'subType', 'qualifiers', 'personId', 'x', 'y', 'possession', 'scoreHome', 'scoreAway', 'edited', 'orderNumber', 'xLegacy', 'yLegacy', 'isFieldGoal', 'side', 'description', 'personIdsFilter', 'teamId', 'teamTricode', 'descriptor', 'jumpBallRecoveredName', 'jumpBallRecoverdPersonId', 'playerName', 'playerNameI', 'jumpBallWonPlayerName', 'jumpBallWonPersonId', 'jumpBallLostPlayerName', 'jumpBallLostPersonId', 'shotDistance', 'shotResult', 'shotActionNumber', 'reboundTotal', 'reboundDefensiveTotal', 'reboundOffensiveTotal', 'pointsTotal', 'assistPlayerNameInitial', 'assistPersonId', 'assistTotal', 'turnoverTotal', 'stealPlayerName', 'stealPersonId', 'officialId', 'foulPersonalTotal', 'foulTechnicalTotal', 'foulDrawnPlayerName', 'foulDrawnPersonId', 'blockPlayerName', 'blockPersonId', 'gameId', 'isTargetScoreLastPeriod', 'area', 'areaDetail']\n",
      "\n",
      "First 5 rows:\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>actionNumber</th>\n",
       "      <th>clock</th>\n",
       "      <th>timeActual</th>\n",
       "      <th>period</th>\n",
       "      <th>periodType</th>\n",
       "      <th>actionType</th>\n",
       "      <th>subType</th>\n",
       "      <th>qualifiers</th>\n",
       "      <th>personId</th>\n",
       "      <th>x</th>\n",
       "      <th>...</th>\n",
       "      <th>foulPersonalTotal</th>\n",
       "      <th>foulTechnicalTotal</th>\n",
       "      <th>foulDrawnPlayerName</th>\n",
       "      <th>foulDrawnPersonId</th>\n",
       "      <th>blockPlayerName</th>\n",
       "      <th>blockPersonId</th>\n",
       "      <th>gameId</th>\n",
       "      <th>isTargetScoreLastPeriod</th>\n",
       "      <th>area</th>\n",
       "      <th>areaDetail</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2</td>\n",
       "      <td>PT10M00.00S</td>\n",
       "      <td>2022-08-18T02:10:38.900Z</td>\n",
       "      <td>1</td>\n",
       "      <td>REGULAR</td>\n",
       "      <td>period</td>\n",
       "      <td>start</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1042200101</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>4</td>\n",
       "      <td>PT09M57.00S</td>\n",
       "      <td>2022-08-18T02:10:40.900Z</td>\n",
       "      <td>1</td>\n",
       "      <td>REGULAR</td>\n",
       "      <td>jumpball</td>\n",
       "      <td>recovered</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1628932</td>\n",
       "      <td>NaN</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1042200101</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>7</td>\n",
       "      <td>PT09M43.00S</td>\n",
       "      <td>2022-08-18T02:10:55.300Z</td>\n",
       "      <td>1</td>\n",
       "      <td>REGULAR</td>\n",
       "      <td>2pt</td>\n",
       "      <td>Jump Shot</td>\n",
       "      <td>pointsinthepaint</td>\n",
       "      <td>1628932</td>\n",
       "      <td>90.676062</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1042200101</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>8</td>\n",
       "      <td>PT09M40.00S</td>\n",
       "      <td>2022-08-18T02:10:57.800Z</td>\n",
       "      <td>1</td>\n",
       "      <td>REGULAR</td>\n",
       "      <td>rebound</td>\n",
       "      <td>defensive</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1629488</td>\n",
       "      <td>NaN</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1042200101</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>9</td>\n",
       "      <td>PT09M32.00S</td>\n",
       "      <td>2022-08-18T02:11:06.500Z</td>\n",
       "      <td>1</td>\n",
       "      <td>REGULAR</td>\n",
       "      <td>3pt</td>\n",
       "      <td>Jump Shot</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1628890</td>\n",
       "      <td>25.316585</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1042200101</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5 rows Ã— 57 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "   actionNumber        clock                timeActual  period periodType  \\\n",
       "0             2  PT10M00.00S  2022-08-18T02:10:38.900Z       1    REGULAR   \n",
       "1             4  PT09M57.00S  2022-08-18T02:10:40.900Z       1    REGULAR   \n",
       "2             7  PT09M43.00S  2022-08-18T02:10:55.300Z       1    REGULAR   \n",
       "3             8  PT09M40.00S  2022-08-18T02:10:57.800Z       1    REGULAR   \n",
       "4             9  PT09M32.00S  2022-08-18T02:11:06.500Z       1    REGULAR   \n",
       "\n",
       "  actionType    subType        qualifiers  personId          x  ...  \\\n",
       "0     period      start               NaN         0        NaN  ...   \n",
       "1   jumpball  recovered               NaN   1628932        NaN  ...   \n",
       "2        2pt  Jump Shot  pointsinthepaint   1628932  90.676062  ...   \n",
       "3    rebound  defensive               NaN   1629488        NaN  ...   \n",
       "4        3pt  Jump Shot               NaN   1628890  25.316585  ...   \n",
       "\n",
       "   foulPersonalTotal  foulTechnicalTotal  foulDrawnPlayerName  \\\n",
       "0                NaN                 NaN                  NaN   \n",
       "1                NaN                 NaN                  NaN   \n",
       "2                NaN                 NaN                  NaN   \n",
       "3                NaN                 NaN                  NaN   \n",
       "4                NaN                 NaN                  NaN   \n",
       "\n",
       "   foulDrawnPersonId blockPlayerName  blockPersonId      gameId  \\\n",
       "0                NaN             NaN            NaN  1042200101   \n",
       "1                NaN             NaN            NaN  1042200101   \n",
       "2                NaN             NaN            NaN  1042200101   \n",
       "3                NaN             NaN            NaN  1042200101   \n",
       "4                NaN             NaN            NaN  1042200101   \n",
       "\n",
       "   isTargetScoreLastPeriod  area areaDetail  \n",
       "0                      NaN   NaN        NaN  \n",
       "1                      NaN   NaN        NaN  \n",
       "2                      NaN   NaN        NaN  \n",
       "3                      NaN   NaN        NaN  \n",
       "4                      NaN   NaN        NaN  \n",
       "\n",
       "[5 rows x 57 columns]"
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#| label: load-dataset\n",
    "\n",
    "# Import WNBA data from the data folder\n",
    "import os\n",
    "\n",
    "# Define the data folder path\n",
    "data_folder = \"data\"\n",
    "\n",
    "# Load individual season data\n",
    "wnba_2022 = pd.read_csv(os.path.join(data_folder, \"wnba_2022.csv\"))\n",
    "wnba_2023 = pd.read_csv(os.path.join(data_folder, \"wnba_2023.csv\"))\n",
    "wnba_2024 = pd.read_csv(os.path.join(data_folder, \"wnba_2024.csv\"))\n",
    "\n",
    "# Combine all seasons into one dataset\n",
    "wnba_data = pd.concat([wnba_2022, wnba_2023, wnba_2024], ignore_index=True)\n",
    "\n",
    "# Display basic information about the dataset\n",
    "print(f\"Total records across all seasons: {len(wnba_data):,}\")\n",
    "print(f\"Columns in dataset: {wnba_data.shape[1]}\")\n",
    "print(f\"Dataset shape: {wnba_data.shape}\")\n",
    "\n",
    "# Show first few rows and column names\n",
    "print(\"\\nDataset columns:\")\n",
    "print(wnba_data.columns.tolist())\n",
    "\n",
    "print(\"\\nFirst 5 rows:\")\n",
    "wnba_data.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3e2cdc30",
   "metadata": {},
   "source": [
    "The dataset required for this project is a granular play-by-play level dataset in order to capture the fouls called within a game with an identifiable referee. The chosen dataset is from Kaggle created by Vladislav Shufinskiy who combined several sources into several datasets for publicly available use. I am choosing to use this source that has been created by another individual due to the granular nature of this project. If I were I collect this data myself, it would require extrenious effort due to limitations on API data requests per game for play-by-play details.\n",
    "\n",
    "The dataset used in this analysis is from the 2022, 2023, 2024 WNBA season webscraped from CDN.NBA.COM by Vladislav Shufinskiy.\n",
    "The dataset will use all games available including in-season, playoffs and finals in order to increase sample size for the analysis.\n",
    "\n",
    "\n",
    "## Research Questions\n",
    "\n",
    "The research questions guiding this project are designed to uncover latent patterns in officiating behavior within the WNBA using unsupervised data mining techniques. Rather than testing predefined hypotheses, the goal is to explore underlying structures and trends in referee decision-making that may indicate systemic tendencies or inconsistencies.\n",
    "\n",
    "### 1. Do home teams have significantly higher win rates under specific referee crews?\n",
    "\n",
    "This question aims to identify clusters of referee crews associated with elevated home team win rates. The project will explore whether specific officiating crews are consistently linked to favorable home outcomes. Patterns that emerge may reflect officiating tendencies that unintentionally reinforce home-court advantage.\n",
    "\n",
    "### 2. When games are officiated by certain referee combinations, do they have higher or lower foul disparity?\n",
    "\n",
    "This question focuses on foul differential as a key indicator of officiating style. The analysis seeks to reveal groups of crews with similar behavioral patterns. Identifying outliers or consistently imbalanced combinations may point to structural officiating trends.\n",
    "\n",
    "### 3. Do certain referees call more fouls on away teams?\n",
    "\n",
    "This question narrows the scope to individual referees to examine whether certain officials consistently contribute to foul imbalances. The objective is to detect underlying officiating bias and identify individuals whose patterns deviate significantly from the normal.\n",
    "\n",
    "\n",
    "## Analysis plan\n",
    "\n",
    "### Problem Introduction\n",
    "\n",
    "The Womenâ€™s National Basketball Association (WNBA) has experienced significant growth in recent years, accompanied by an increasing emphasis on data analytics to enhance forecasting and anomaly detection capabilities. This project seeks to evaluate the fairness of officiating in the WNBA by applying machine learning techniques to referee assignment data, foul differentials, and game outcomes. The primary objective is to identify potential officiating bias and assess the extent to which individual referees may contribute to a home-court advantage.\n",
    "\n",
    "### Problem Formulation\n",
    "\n",
    "This study will examine potential officiating bias in WNBA games by analyzing referee assignment data, foul differentials, and game outcomes across multiple seasons. The analysis will proceed in the following stages:\n",
    "\n",
    "\n",
    "#### 1. Data Collection and Preprocessing\n",
    "\n",
    "- **Data Sources:**\n",
    "  Collecting data from <https://www.kaggle.com/datasets/brains14482/nba-playbyplay-and-shotdetails-data-19962021/data> which is a play-by-play datasets with referee assignments.\n",
    "\n",
    "- **Variables of Interest:**  \n",
    "  - Game metadata: date, teams, location (home/away), final scores  \n",
    "  - Referee assignments (names or IDs, crew combinations)  \n",
    "  - Team foul counts\n",
    "  - Game outcomes (win/loss, point differential)\n",
    "\n",
    "- **Data Cleaning:**  \n",
    "  - Normalize referee names across games  \n",
    "  - Merge datasets to associate referee crews with game-level statistics  \n",
    "  - Handle missing or inconsistent values  \n",
    "  - Feature engineering such as average fouls per team, foul differential, home team win indicator, and officiating crew identifiers  \n",
    "\n",
    "\n",
    "#### 2. Descriptive Statistics\n",
    "\n",
    "- Summarize foul counts by team and referee  \n",
    "- Visualize average foul differential by referee and referee crew  \n",
    "- Compute home vs. away win rates across different referee combinations \n",
    "- Generate pairwise correlations to identify potentially relevant feature groupings  \n",
    "\n",
    "#### 3. Unsupervised Learning (Pattern Discovery)\n",
    "\n",
    "- **K-Means Clustering:**  \n",
    "\n",
    "  Use K-means clustering to group:\n",
    "  - Referee crew based on game-level foul and outcome patterns\n",
    "  - Individual referees based on their aggregated officiating behavior across multiple games\n",
    "\n",
    "- **Dimensionality Reduction:**  \n",
    "  Apply Principal Component Analysis (PCA) to identify latent components in officiating behavior (such as home bias, foul volume, crew consistency)  \n",
    "\n",
    "#### 4. Cluster Interpretation\n",
    "\n",
    "- Analyze each clusterâ€™s centroid to identify distinguishing features (such as high foul disparity, frequent home wins)\n",
    "- Label clusters based on behavioral tendencies (such as \"neutral crews\", \"home-favoring referees\", \"high-caller crews\")\n",
    "- Identify any outlier referees or crews with extreme values\n",
    "\n",
    "\n",
    "### 5. Reporting and Visualization\n",
    "\n",
    "- Create visualizations including heatmaps, bar charts, and PCA plot to articulate findings  \n",
    "- Plot clustered referee data to visualize separation and cohesion  \n",
    "- Discuss implications of findings in the context of WNBA officiating policy and fairness\n",
    "- Provide future recommendations to improve the analysis  \n",
    "\n",
    "\n",
    "## Plan of Attack\n",
    "\n",
    "## Project Timeline\n",
    "\n",
    "| Milestone                         | Task                                                                                                            | Due Date   |\n",
    "|----------------------------------|------------------------------------------------------------------------------------------------------------------|------------|\n",
    "| Submit Proposal                  | Finalize and submit initial proposal for others to provide feedback                                             | 8/3/2025   |\n",
    "| Revise Proposal                  | Address all peer feedback as needed                                                                             | 8/6/2025   |\n",
    "| Submit Revised Proposal          | Incorporate and address all feedback for instructor review                                                      | 8/8/2025   |\n",
    "| Data Collection & Cleaning       | - Gather and clean WNBA game logs, referee assignments, and team stats  <br> - Merge datasets and ensure consistent formatting | 8/10/2025  |\n",
    "| Feature Engineering & EDA        | - Create variables such as foul differential, crew IDs, and home/away indicators  <br> - Visualize trends and explore feature distributions | 8/12/2025  |\n",
    "| Pattern Discovery with K-means   | - Standardize features and apply K-means clustering  <br> - Use the elbow method and silhouette scores to select optimal clusters | 8/14/2025  |\n",
    "| Cluster Interpretation           | - Interpret each clusterâ€™s characteristics (e.g., home bias, foul disparity)  <br> - Identify and analyze outlier referees or crews | 8/16/2025  |\n",
    "| Visual & Storytelling            | Create and finalize visuals that showcase the clustering results, such as PCA plots and cluster heatmaps        | 8/17/2025  |\n",
    "| Final Write-Up & Presentation    | - Create, refine, and finalize the report, code, and presentation  <br> - Ensure all results are well-documented and reproducible | 8/19/2025  |\n",
    "| Final Submission                 | - Submit final report, code, and presentation  <br> - Back up to GitHub (or drive)                              | 8/20/2025  |\n",
    "\n",
    "### Repo Organization\n",
    "\n",
    "| Path / File              | Description |\n",
    "|-----------|---------------------------------------------|\n",
    "| `.github/`               | Contains GitHub-specific files, including workflows, actions, and issue management templates. |\n",
    "| `_extra/`                | Stores miscellaneous files that do not fit into other project categories; serves as a repository for supplementary documents. |\n",
    "| `_freeze/`               | Houses frozen environment files detailing the projectâ€™s setup and dependencies. |\n",
    "| `data/`                  | Directory for all essential data files, including input datasets and resources required for analysis. |\n",
    "| `images/`                | Central repository for visual assets such as diagrams, charts, and screenshots used for documentation and presentations. |\n",
    "| `.gitignore`             | Specifies files and directories to exclude from Git version control. |\n",
    "| `README.md`              | Central documentation file providing project overview, setup instructions, and usage guidelines. |\n",
    "| `_quarto.yml`            | Configuration file for Quarto, specifying rendering options and document settings. |\n",
    "| `about.qmd`              | Provides contextual information about the project and introduces team members and their roles. |\n",
    "| `index.qmd`              | Main page of the project write-up, including code, visualizations, and final results. |\n",
    "| `presentation.qmd`       | Quarto file used to create a slideshow of the final project presentation. |\n",
    "| `project-final.Rproj`    | RStudio project file that defines project-level settings for R-based workflows. |\n",
    "| `proposal.qmd`           | Contains the project proposal, including dataset descriptions, metadata, research questions, and a weekly progress plan. |\n",
    "| `requirements.txt`       | Lists required Python packages and versions necessary for reproducing the project environment. |\n",
    "\n",
    "\n",
    "### References\n",
    "\n",
    "[1] WNBA Dataset: https://www.kaggle.com/datasets/brains14482/nba-playbyplay-and-shotdetails-data-19962021/data used in the project"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3",
   "path": "C:\\Users\\amyes\\anaconda3\\share\\jupyter\\kernels\\python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
